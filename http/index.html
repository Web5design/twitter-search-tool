<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Twitter search tool</title>
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/bootstrap.min.css">
    <link rel="stylesheet" href="http://x.scraperwiki.com/vendor/style/metro.bootstrap.css">
    <script src="http://x.scraperwiki.com/js/scraperwiki.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-url-parser/2.2.1/purl.min.js"></script>

    <meta http-equiv="cleartype" content="on">

    <style type="text/css">

body {
  padding: 20px;
}

h2 {
  margin-top: 0;
}

.muted {
  margin-right: 10px;
}

p.loading {
    display: none;

    margin-top: 100px;
    padding-top: 50px;
    text-align: center;
    background: transparent url('tool-loader.gif') center top no-repeat;
    color: #666;
    font-size: 20px;
}       

    </style>
  </head>
  <body>

     <div id="got-settings" style="display:none">
         <h2>Getting @<span class="who">...</span>'s followers</h2>

         <p>New followers are added once per hour. 

         <button class="btn btn-primary" type="button" id="refresh" disabled="disabled">Refresh!</button> (also fixes any authentication issues)

         <p>If the user has a large number of followers they gradually trickle in.</p>

         <hr>

         <h2>Change settings</h2>

         <p>You need to clear the current data to change the settings. Alternatively, make a new dataset.</p>

         <button class="btn btn-danger" type="button" id="clear-data" disabled="disabled">Clear data</button>
    </div>

    <div id="get-settings" style="display:none">
        <h2>Get Twitter followers</h2>

        <div class="form-horizontal">
            <div class="control-group">
                <label class="control-label" for="q">Twitter user</label>
                <div class="controls">
                    <input type="text" name="q" size="80" id="q" placeholder="@spikingneural">
                    <button class="btn btn-primary" type="button" id="submit" disabled="disabled">Go!</button>
                </div>
            </div>
        </div>
    </div>

   <script>
        // Event function for when they click on either the Go! or the Refresh buttons.
        // Calls out to the Python script get.py, which does the actual Twitter
        // calling. 
        var scrape_action = function() {
            var btn = $(this)
            var original_text = btn.text()

            $('pre,.alert,.help-inline').remove()
            $('.control-group').removeClass('error')

            var q = $('#q').val()
            q = q.replace(/^@/,'')
            if (q.match(/[^a-zA-Z0-9_]/)) {
                $(".control-group").addClass('error')
                $(".controls").append('<span class="help-inline">Twitter user names only use the alphabet, numbers and _</span>')
                return
            }

            // Pass various OAuth bits of data to the Python script that is going to do the work
            btn.addClass('disabled').html('Loading&hellip;').attr('disabled', true)
            scraperwiki.exec('echo ' + escapeshell(q) + '>user.txt; tool/get.py "' + callback_url + '" "' + oauth_verifier + '"').done(function(content) {
                console.log(content)
                // Redirect to Twitter if we get a URL telling us to
                if (content.match(/^https:\/\/api.twitter.com/)) {
                    scraperwiki.tool.redirect(content)
                    return
                }

                // We got the first lot successfully
                if (content.match(/^ok-updating/)) {
                    scraperwiki.exec('crontab tool/crontab')
                    var datasetUrl = "/dataset/" + scraperwiki.boxName
                    scraperwiki.tool.redirect(datasetUrl)
                    return
                }

                var msg = "<b>Failed to import!</b>"
                var style = "error"
                if (content.match(/^rate-limit/)) {
                    msg = "<b>Twitter rate limit exceeded!</b> Try again in 15 minutes."
                    style = 'warning'
                }

                if (content.match(/^not-there/)) {
                    $(".control-group").addClass('error')
                    $(".controls").append('<span class="help-inline">There isn\'t a Twitter user with that name.</span>')
                    btn.removeClass('disabled').html('Try again!').attr('disabled', false)
                    return
                }
            
                // Otherwise an unknown error - e.g. an unexpected stack trace
                btn.removeClass('disabled').html('Try again!').attr('disabled', false)
                var p = $('<p>').addClass('alert alert-' + style).html(msg + ' Click here to show technical details.').on('click', function() {
                    $(this).next('pre').toggle()
                }).css('cursor', 'pointer')
                var pre = $('<pre>').html(content).hide()
                $('body').prepend(pre)
                $('body').prepend(p)
                return
            })
        }

      // Show the right form (get settings, or the refresh data one)
      var show_hide_stuff = function() {
            // Find out what user it is
            scraperwiki.exec('touch user.txt; cat user.txt').done(function(data) {
                data = $.trim(data)
                $('#q').val(data)
                $('.who').text(data)
            })

            // Show right form
            scraperwiki.sql('select * from sqlite_master', function(results){
                var got_table = false
                for (var key in results) {
                    var table = results[key]
                    if (table.name == "twitter_followers" || table.name == "twitter_main") {
                        got_table = true
                        break
                    }
                }
                if (got_table) {
                    $('#get-settings').hide()
                    $('#got-settings').show()
                } else {
                    $('#get-settings').show()
                    $('#got-settings').hide()
                }

            }, function(results) {
                // this is bad as it will masks real errors - we have to show the form as
                // no SQLite database gives an error
                $('#get-settings').show()
                $('#got-settings').hide()
            })
      }

      var escapeshell = function(cmd) {
        return "'"+cmd.replace(/'/g,"'\\''")+"'";
      };

       // Get OAuth parameters that we need from the URL
        var settings = scraperwiki.readSettings()
        var callback_url
        var oauth_verifier
        scraperwiki.tool.getURL(function(our_url) {
            console.log(our_url)
            var url = $.url(our_url)
            oauth_verifier = url.param('oauth_verifier')
            // remove query parameters for the callback URL, so they don't stack up if we
            // go multiple times to Twitter 
            callback_url = url.attr('base') + url.attr('path')
            // only when we have the callback URL, allow the submit button to be clicked
            $("#submit,#refresh,#clear-data").removeAttr("disabled")
        })

      $(document).ready(function() {
        show_hide_stuff()

        $('#q').on('keypress', function(e){
          if(e.which == 13){
            $('#submit').trigger('click')
          }
        })

        $('#clear-data').on('click', function() {
            $('pre,.alert,.help-inline').remove()
            scraperwiki.exec("crontab -r; rm -fr scraperwiki.sqlite").done(function(content) {
                show_hide_stuff()
            })
        })

        $('#submit,#refresh').on('click', scrape_action)
    })
    </script>

  </body>
</html>
